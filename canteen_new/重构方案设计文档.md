# 后端重构说明
改了一下各个文件的组织和布局，这样模块之间更清晰一点。原项目文件没有改，还在canteen_system下。
重新组织的本项目放在了canteen_new目录下，可以之间进入canteen_new，以此为根目录独立运行项目

## 模块划分

### 1. API模块 (前后端交互模块)
**位置**: `canteen_new/api/`

| 文件 | 职责 | 包含接口 |
|------|------|----------|
| `auth.py` | 认证相关API | 用户登录、商家登录、用户注册、验证码获取 |
| `user.py` | 用户相关API | 用户信息、用户收藏列表 |
| `dishes.py` | 菜品相关API | 菜品搜索、菜品筛选、AI智能推荐、热门推荐 |
| `orders.py` | 订单相关API | 下单菜品、收藏菜品 |
| `merchant.py` | 商家管理API | 商家菜品列表、添加菜品、更新菜品、删除菜品、客流量上报 |
| `stats.py` | 数据统计API | 实时客流量 |

### 2. 数据模块 (数据库交互模块)
**位置**: `canteen_new/data/`

| 文件 | 职责 | 包含功能 |
|------|------|----------|
| `models.py` | 数据模型定义 | 用户、商家、菜品、订单、客流量等模型 |
| `repositories.py` | 数据访问层 | 数据库CRUD操作封装 |
| `services.py` | 业务逻辑层 | 业务规则和流程实现 |

### 3. AI模块 (AI交互模块)
**位置**: `canteen_new/ai/`

| 文件 | 职责 | 包含功能 |
|------|------|----------|
| `services.py` | AI服务实现 | AI菜品推荐、用户行为分析、客流量预测 |
| `utils.py` | AI工具函数 | NLP处理、相似度计算等工具 |

### 4. 核心模块
**位置**: `canteen_new/core/`

| 文件 | 职责 |
|------|------|
| `response.py` | 统一响应格式封装 |
| `auth.py` | JWT认证相关功能 |
| `exceptions.py` | 自定义异常类定义 |

## 各模块接口设计

### API模块接口设计

#### auth.py
1. **用户登录** - `POST /api/auth/user/login`
   - **请求体**:
     ```json
     {
       "username": "string, 必填, 用户名",
       "password": "string, 必填, 密码",
       "captcha": "string, 必填, 验证码"
     }
     ```
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "user": {
           "id": "number, 用户ID",
           "username": "string, 用户名",
           "email": "string, 邮箱",
           "type": "user, 用户类型",
           "avatar": "string, 头像URL"
         },
         "token": "string, JWT令牌"
       },
       "message": "登录成功"
     }
     ```

2. **商家登录** - `POST /api/auth/merchant/login`
   - **请求体**:
     ```json
     {
       "username": "string, 必填, 商家账号",
       "password": "string, 必填, 密码",
       "captcha": "string, 必填, 验证码"
     }
     ```
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "merchant": {
           "id": "number, 商家ID",
           "username": "string, 商家账号",
           "storeName": "string, 店铺名称",
           "type": "merchant, 用户类型",
           "canteen": "string, 所属食堂"
         },
         "token": "string, JWT令牌"
       },
       "message": "商家登录成功"
     }
     ```

3. **用户注册** - `POST /api/auth/register`
   - **请求体**:
     ```json
     {
       "type": "string, 必填, 注册类型 (user|merchant)",
       "username": "string, 必填, 用户名",
       "password": "string, 必填, 密码",
       "confirmPassword": "string, 必填, 确认密码",
       "email": "string, 必填, 邮箱",
       "storeName": "string, 可选, 商家必填-店铺名称",
       "canteen": "string, 可选, 商家必填-所属食堂"
     }
     ```
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "id": "number, 用户ID",
         "username": "string, 用户名"
       },
       "message": "注册成功"
     }
     ```

4. **验证码获取** - `GET /api/auth/captcha`
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "captchaCode": "string, 验证码文本",
         "captchaImage": "string, base64编码的验证码图片"
       }
     }
     ```

#### user.py
1. **用户信息** - `GET /api/user/profile`
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "id": "number, 用户ID",
         "username": "string, 用户名",
         "email": "string, 邮箱",
         "avatar": "string, 头像URL",
         "preferences": {
           "favoriteFlavors": ["string", "口味偏好"],
           "budgetRange": {
             "min": "number, 最低预算",
             "max": "number, 最高预算"
           },
           "dietaryRestrictions": ["string", "饮食限制"]
         }
       }
     }
     ```

2. **用户收藏列表** - `GET /api/user/favorites`
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "favorites": [
           {
             "id": "number, 收藏ID",
             "dishId": "number, 菜品ID",
             "dishName": "string, 菜品名称",
             "price": "number, 价格",
             "canteen": "string, 所属食堂",
             "addedAt": "string, 收藏时间 (ISO格式)"
           }
         ]
       }
     }
     ```

#### dishes.py
1. **菜品搜索** - `GET /api/dishes/search?q={query}&page={page}&limit={limit}`
   - **查询参数**: `q`(搜索关键词), `page`(页码), `limit`(每页数量)
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "dishes": [
           {
             "id": "number, 菜品ID",
             "name": "string, 菜品名称",
             "price": "number, 价格",
             "rating": "number, 评分 (0-5)",
             "description": "string, 菜品描述",
             "canteen": "string, 所属食堂",
             "waitTime": "string, 等待时间",
             "tags": ["string", "标签"],
             "image": "string, 图片URL",
             "category": "string, 品类",
             "taste": "string, 口味",
             "isFavorite": "boolean, 是否已收藏"
           }
         ]
       },
       "pagination": {
         "page": "number, 当前页码",
         "limit": "number, 每页数量",
         "total": "number, 总记录数",
         "pages": "number, 总页数"
       }
     }
     ```

2. **菜品筛选** - `GET /api/dishes/filter?category={category}&flavors={flavors}&priceMin={min}&priceMax={max}&crowd={crowd}`
   - **查询参数**: `category`(品类), `flavors`(口味), `priceMin`(最低价格), `priceMax`(最高价格), `crowd`(人流量)
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "dishes": "Array<Dish>, 菜品列表",
         "filters": {
           "category": "string, 筛选品类",
           "flavors": ["string", "筛选口味"],
           "priceRange": {
             "min": "number, 价格下限",
             "max": "number, 价格上限"
           },
           "crowd": "string, 人流量筛选"
         }
       }
     }
     ```

3. **AI智能推荐** - `POST /api/dishes/ai-recommend`
   - **请求体**:
     ```json
     {
       "query": "string, 必填, 用户查询文本",
       "preferences": {
         "flavors": ["string", "口味偏好"],
         "budget": {
           "min": "number, 最低预算",
           "max": "number, 最高预算"
         },
         "dietary": ["string", "饮食限制"]
       }
     }
     ```
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "recommendations": [
           {
             "dish": "Dish对象, 推荐菜品",
             "reason": "string, 推荐理由",
             "matchScore": "number, 匹配度 (0-1)"
           }
         ],
         "queryAnalysis": {
           "intent": "string, 查询意图",
           "extractedPreferences": {
             "flavors": ["string", "提取的口味"],
             "budget": {
               "min": "number, 提取的最低预算",
               "max": "number, 提取的最高预算"
             },
             "category": "string, 提取的品类"
           }
         }
       }
     }
     ```

4. **热门推荐** - `GET /api/dishes/popular`
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "dishes": [
           {
             "id": "number, 菜品ID",
             "name": "string, 菜品名称",
             "price": "number, 价格",
             "rating": "number, 评分",
             "description": "string, 描述",
             "canteen": "string, 食堂",
             "waitTime": "string, 等待时间",
             "tags": ["string", "标签"],
             "color": "string, 背景颜色",
             "icon": "string, 图标类名"
           }
         ]
       }
     }
     ```

#### orders.py
1. **下单菜品** - `POST /api/orders/create`
   - **请求体**:
     ```json
     {
       "dishId": "number, 必填, 菜品ID",
       "quantity": "number, 可选, 数量 (默认1)",
       "specialInstructions": "string, 可选, 特殊要求",
       "pickupTime": "string, 可选, 取餐时间 (ISO格式)"
     }
     ```
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "orderId": "number, 订单ID",
         "status": "pending, 订单状态",
         "estimatedWaitTime": "number, 预计等待时间(分钟)",
         "totalPrice": "number, 总价格"
       },
       "message": "下单成功"
     }
     ```

2. **收藏菜品** - `POST /api/favorites/add`
   - **请求体**:
     ```json
     {
       "dishId": "number, 必填, 菜品ID"
     }
     ```
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "favoriteId": "number, 收藏ID"
       },
       "message": "收藏成功"
     }
     ```

#### merchant.py
1. **商家菜品列表** - `GET /api/merchant/dishes`
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "dishes": [
           {
             "id": "number, 菜品ID",
             "name": "string, 菜品名称",
             "price": "number, 价格",
             "category": "string, 品类",
             "taste": "string, 口味",
             "description": "string, 描述",
             "status": "active|inactive, 状态",
             "createdAt": "string, 创建时间",
             "updatedAt": "string, 更新时间"
           }
         ]
       }
     }
     ```

2. **添加菜品** - `POST /api/merchant/dishes`
   - **请求体**:
     ```json
     {
       "name": "string, 必填, 菜品名称",
       "price": "number, 必填, 价格",
       "category": "string, 必填, 品类",
       "taste": "string, 必填, 口味",
       "description": "string, 可选, 描述",
       "image": "string, 可选, base64编码的图片"
     }
     ```
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "id": "number, 菜品ID",
         "name": "string, 菜品名称",
         "price": "number, 价格"
       },
       "message": "菜品添加成功"
     }
     ```

3. **更新菜品** - `PUT /api/merchant/dishes/{id}`
   - **请求体**:
     ```json
     {
       "name": "string, 可选, 菜品名称",
       "price": "number, 可选, 价格",
       "category": "string, 可选, 品类",
       "taste": "string, 可选, 口味",
       "description": "string, 可选, 描述",
       "image": "string, 可选, base64编码的图片",
       "status": "active|inactive, 可选, 状态"
     }
     ```

4. **删除菜品** - `DELETE /api/merchant/dishes/{id}`
   - **响应体**:
     ```json
     {
       "success": true,
       "message": "菜品删除成功"
     }
     ```

5. **客流量上报** - `POST /api/merchant/traffic`
   - **请求体**:
     ```json
     {
       "count": "number, 必填, 客流量人数",
       "waitingTime": "number, 必填, 平均等待时间(分钟)",
       "timestamp": "string, 可选, 时间戳 (ISO格式)"
     }
     ```
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "trafficId": "number, 上报记录ID",
         "currentTraffic": "number, 当前客流量",
         "avgWaitTime": "number, 平均等待时间",
         "updatedAt": "string, 更新时间"
       },
       "message": "客流量信息更新成功"
     }
     ```

#### stats.py
1. **实时客流量** - `GET /api/stats/traffic`
   - **响应体**:
     ```json
     {
       "success": true,
       "data": {
         "trafficData": [
           {
             "canteen": "string, 食堂名称",
             "currentTraffic": "number, 当前客流量",
             "avgWaitTime": "number, 平均等待时间",
             "level": "low|medium|high, 拥挤程度",
             "lastUpdated": "string, 最后更新时间"
           }
         ]
       }
     }
     ```

### 数据模块接口设计

#### repositories.py
1. **用户相关操作**
   - `get_user_by_id(user_id)`
   - `get_user_by_username(username)`
   - `create_user(user_data)`
   - `update_user_preferences(user_id, preferences)`

2. **商家相关操作**
   - `get_merchant_by_id(merchant_id)`
   - `get_merchants_by_hall(hall)`
   - `create_merchant(merchant_data)`

3. **菜品相关操作**
   - `search_dishes(query, filters)`
   - `get_dish_by_id(dish_id)`
   - `get_dishes_by_merchant(merchant_id)`
   - `create_dish(dish_data)`
   - `update_dish(dish_id, update_data)`
   - `delete_dish(dish_id)`

4. **订单相关操作**
   - `create_order(order_data)`
   - `get_user_orders(user_id)`
   - `add_favorite(user_id, dish_id)`
   - `get_user_favorites(user_id)`

5. **客流量相关操作**
   - `record_traffic(traffic_data)`
   - `get_traffic_statistics(filters)`

#### services.py
1. **认证服务**
   - `authenticate_user(username, password)`
   - `authenticate_merchant(username, password)`
   - `register_user(user_data)`

2. **菜品服务**
   - `search_dishes_service(query, filters)`
   - `filter_dishes_service(criteria)`
   - `get_popular_dishes()`

3. **订单服务**
   - `create_order_service(order_data)`
   - `add_favorite_service(user_id, dish_id)`

4. **商家服务**
   - `manage_dishes_service(merchant_id, action, data)`
   - `report_traffic_service(merchant_id, traffic_data)`

### AI模块接口设计

#### services.py
1. **AI菜品推荐**
   - `recommend_dishes(user_query, user_preferences)`
   - 功能：基于用户查询和偏好进行智能推荐
   - 返回：推荐菜品列表、推荐理由、匹配度

2. **用户行为分析**
   - `analyze_user_behavior(user_id)`
   - 功能：分析用户偏好、消费习惯等
   - 返回：用户画像、行为模式

3. **客流量预测**
   - `predict_traffic(merchant_id, date, time_slot)`
   - 功能：预测未来客流量
   - 返回：预测数据、置信度

## 数据流设计

```
前端 (Vue)
    ↓ HTTP请求 (RESTful API)
API模块 (处理请求/响应)
    ↓ 服务调用
数据模块 (业务逻辑处理)
    ↓ 数据访问/AI调用
数据库/AI模块
    ↓ 返回结果
API模块 (格式化响应)
    ↓ JSON响应
前端 (Vue)
```

## 统一规范

### 响应格式
```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "error": {
    "code": "ERROR_CODE",
    "details": "错误详情"
  },
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "pages": 10
  }
}
```

### 认证机制
- 使用JWT Token进行身份验证
- 需要认证的接口在请求头中包含 `Authorization: Bearer {token}`

### 错误处理
- 统一的错误码规范
- 详细的错误信息返回
- 适当的HTTP状态码
